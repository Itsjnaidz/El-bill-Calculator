<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculate Bill</title>
  <link rel="stylesheet" href="CSS/calculator_page.css" />
  <style>
    /* Small overrides: remove underlines & size icons */
    a { text-decoration: none; color: inherit; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; }
    .sidebar ul li { margin: 6px 0; }
    .sidebar ul li a { display:flex; align-items:center; gap:12px; padding:12px 16px; width:100%; }
    .side-icon, .icon, .btn-icon { display:inline-flex; width:18px; height:18px; flex-shrink:0; }
    .signin-btn, .btn { display:inline-flex; align-items:center; gap:10px; justify-content:center; }
  </style>
</head>
<body>

  <div class="container">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <ul>
        <li>
          <a href="user_dashboard.html" aria-label="Dashboard">
            <span class="side-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="3" width="8" height="8" fill="currentColor"/>
                <rect x="13" y="3" width="8" height="8" fill="currentColor"/>
                <rect x="3" y="13" width="8" height="8" fill="currentColor"/>
                <rect x="13" y="13" width="8" height="8" fill="currentColor"/>
              </svg>
            </span>
            <span>Dashboard</span>
          </a>
        </li>

        <li class="active">
          <a href="calculator_page.html" aria-label="Calculate Bill">
            <span class="side-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="1.2" fill="none"/>
                <rect x="8.5" y="7" width="7" height="2" rx="0.5" fill="currentColor"/>
                <circle cx="9" cy="13.5" r="0.9" fill="currentColor"/>
                <circle cx="12" cy="13.5" r="0.9" fill="currentColor"/>
                <circle cx="15" cy="13.5" r="0.9" fill="currentColor"/>
              </svg>
            </span>
            <span>Calculate Bill</span>
          </a>
        </li>

        <li>
          <a href="result_page.html" aria-label="History">
            <span class="side-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1.2" fill="none"/>
                <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span>History</span>
          </a>
        </li>

        <li>
          <a href="#" onclick="handleLogout(); return false;" aria-label="Log out">
            <span class="side-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                   xmlns="http://www.w3.org/2000/svg">
                <path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 12H9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13 19H6a2 2 0 01-2-2V7a2 2 0 012-2h7" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span>Log out</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">

      <!-- HEADER -->
      <div class="header" style="display:flex;align-items:center;gap:16px;">
        <a href="profile_page.html" class="profile-link" style="display:flex;align-items:center;gap:12px;">
          <h2 style="margin:0;">Calculate Bill</h2>

          <div class="user-box" style="display:flex;align-items:center;gap:8px;margin-left:12px;">
            <span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="8" r="3" fill="currentColor"/>
                <path d="M5 20c1.8-3 5-5 7-5s5.2 2 7 5" fill="currentColor"/>
              </svg>
            </span>
            <p id="usernameTxt" style="margin:0 0 0 8px;">User</p>
          </div>
        </a>
      </div>

      <!-- CARD -->
      <div class="card">
        <form onsubmit="event.preventDefault();">
          <label>Month:</label>
          <input id="month" type="text" placeholder="e.g., January 2024">

          <label>Rate per kWh (₱):</label>
          <input id="cost_per_kwh" type="number" step="0.01">

          <label>Usage (kWh):</label>
          <input id="power_consumption" type="number" step="0.01">

          <button type="button" id="btn_calculate" class="btn">
            <span class="btn-icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13 2L3 14h7l-1 8L21 10h-7l1-8z" fill="currentColor"/>
              </svg>
            </span>
            Calculate
          </button>
        </form>

        <div id="result"></div>
      </div>

    </div>

  </div>

  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const session = await initAuth(); // initialize auth
      if (session) {
        const user = await getCurrentUser();
        if (user) {
          document.getElementById("usernameTxt").innerText = user.user_metadata?.full_name || user.email;
        }
      }
    });

    document.getElementById("btn_calculate").addEventListener("click", async function () {
      const month = document.getElementById("month");
      const power = document.getElementById("power_consumption");
      const cost = document.getElementById("cost_per_kwh");
      const result = document.getElementById("result");

      if (!month.value || !power.value || !cost.value) {
        alert("Please fill in all fields!");
        return;
      }

      const user = await getCurrentUser();
      if (!user) {
        alert("You must be logged in to save calculations!");
        window.location.href = "login.html";
        return;
      }

      const total = parseFloat(cost.value) * parseFloat(power.value);
      result.innerHTML = `<h3>Total Bill: ₱ ${total.toFixed(2)}</h3>`;

      try {
        const { error } = await supabaseClient
          .from("calculations")
          .insert([
            {
              user_id: user.id,
              month: month.value,
              power_consumption: parseFloat(power.value),
              cost_per_kwh: parseFloat(cost.value),
              result: total,
            }
          ]);
        if (error) {
          console.error(error);
          alert("Saved locally but failed to save to DB.");
        }
      } catch (e) {
        console.error(e);
        alert("Error saving calculation: " + e.message);
      }

      month.value = "";
      power.value = "";
      cost.value = "";
    });

    async function handleLogout() {
      const success = await signOut();
      if (success) {
        window.location.href = "login.html";
      } else {
        alert("Error logging out. Please try again.");
      }
    }
  </script>
</body>
</html>